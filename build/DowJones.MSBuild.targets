<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildProjectDirectory)\MSBuild.Community.Tasks.Targets" Condition="$(MSBuildCommunityTasksLib) == ''" />

  <!-- Use the TeamCity NUnit task if running under TeamCity -->
  <UsingTask TaskName="NUnit" AssemblyFile="$(teamcity_dotnet_nunitlauncher_msbuild_task)" Condition="'$(TEAMCITY_VERSION)' != ''"/>
  
  <Target Name="DJ-CleanArtifactsDir">
    <RemoveDir Directories="$(ArtifactsDir)" Condition="Exists('$(ArtifactsDir)')" ContinueOnError="true"/>
    <MakeDir Directories="$(ArtifactsDir)"/>
    <MakeDir Directories="$(DistDir)" Condition="$(DistDir) != ''"/>
  </Target>

  <ItemGroup>
    <XmlSubNamespaceDefinitions Include="dj=urn:dowjones-com;"/>
  </ItemGroup>
  
  <Target Name="DJ-AddMetadataToXmlSubs">
    <CreateItem Include="@(XmlSubs)"
                AdditionalMetadata="Config=%(XmlSubConfigs.Identity)">
      <Output TaskParameter="Include" ItemName="_XmlSubsWithConfig"/>
    </CreateItem>

    <CreateItem Include="@(_XmlSubsWithConfig)"
                AdditionalMetadata="Root=/configuration;
                  DestFile=%(DestDir)\%(Filename).%(Config);
                  ContentFile=%(RootDir)%(Directory)%(Filename);"
                PreserveExistingMetadata="true">
      <Output TaskParameter="Include" ItemName="_XmlSubs"/>
    </CreateItem>
  </Target>

  <Target Name="DJ-XmlSub" Inputs="@(_XmlSubs->'%(Identity)');@(_XmlSubs->'%(ContentFile)')" Outputs="%(DestFile)" DependsOnTargets="DJ-AddMetadataToXmlSubs">
    <Message Text="Applying XML substitutions to %(_XmlSubs.ContentFile) for %(_XmlSubs.Config)..."/>

    <!-- Copy the content file over to the config-specific version first -->
    <Copy SourceFiles="%(_XmlSubs.ContentFile)" DestinationFiles="%(_XmlSubs.DestFile)"/>
    
    <!-- First apply anything under ALL -->
    <XmlMassUpdate SubstitutionsFile="%(_XmlSubs.Identity)"
                   ContentFile="%(_XmlSubs.DestFile)"
                   SubstitutionsRoot="%(_XmlSubs.Root)/dj:ALL"
                   ContentRoot="%(_XmlSubs.Root)"
                   NamespaceDefinitions="@(XmlSubNamespaceDefinitions)"
                   IgnoreMissingSubstitutionsRoot="true"/>

    <!-- Then apply config specific section -->
    <XmlMassUpdate SubstitutionsFile="%(_XmlSubs.Identity)"
                   ContentFile="%(_XmlSubs.DestFile)"
                   SubstitutionsRoot="%(_XmlSubs.Root)/dj:%(_XmlSubs.Config)"
                   ContentRoot="%(_XmlSubs.Root)"
                   NamespaceDefinitions="@(XmlSubNamespaceDefinitions)"
                   IgnoreMissingSubstitutionsRoot="true"/>
  </Target>
  
  <Target Name="DJ-ZipWebsites" Inputs="@(ZipWebsites)" Outputs="%(Identity)">
    <CreateItem Include="@(ZipWebsites->'$(WebsitesDir)\%(Identity)\**\*.*')">
      <Output TaskParameter="Include" ItemName="_ZipFiles"/>
    </CreateItem>
    
    <Zip Files="@(_ZipFiles)"
         ZipFileName="@(ZipWebsites->'$(DistDir)\%(Identity)-MULTI-$(Version).zip')"
         Quiet="true"
         WorkingDirectory="@(ZipWebsites->'$(WebsitesDir)\%(Identity)')"/>
         
  </Target>

  <Target Name="DJ-GitBranch">
    <GitBranch Condition="$(git_branch) == ''">
      <Output TaskParameter="Branch" PropertyName="git_branch"/>
    </GitBranch>
  </Target>

  <Target Name="DJ-NuGetPack" Inputs="@(NuGetManifests)" Outputs="@(NuGetManifests->'$(DistDir)\%(Filename).$(Version).nupkg')">
    <NuGetPack File="%(NuGetManifests.Identity)"
               OutputDirectory="$(DistDir)"
               ToolPath="$(ProjectRoot)\tools\nuget"
               Version="$(Version)"
               Properties="OutDir=$([System.IO.Path]::GetFullPath('$(ArtifactsDir)\%(NuGetManifests.Filename)'));ArtifactsDir=$([System.IO.Path]::GetFullPath($(ArtifactsDir)));RootDir=$([System.IO.Path]::GetFullPath($(ProjectRoot)));"
               BasePath="@(NuGetManifests->'%(RootDir)%(Directory)')"
               Verbose="true"/>
  </Target>

</Project>
